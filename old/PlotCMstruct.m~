function [fh]=PlotCMstruct(varargin)
 
% up to two inputs: 
%     PlotCMstruct([CMstructName])
%     PlotCMstruct([CMstructName],[SurvNum])

%  Plots the data is the CPGMOP structural array MopStruct. 
%  If a SurveyNum is also input, it just plots the data for
%  that struct array index number.
%
%  returns the figure handle 

% assign variables

% figure out if it is a single MOP struct array or a nested set of
%  MOP struct arrays
S=varargin{1};
if size(fieldnames(varargin{1}),1) > 1  % single MOP struct array 
MopStructType=inputname(1); % get the actual input struct variable name
isnest=0; % no nest logical
nmops=1;
MopNumber=S(1).Mopnum;
else % already a nested struct of mops
%S=varargin{1}; % assign input struct array a generic name
MopStructType=fieldnames(S); % Mop struct type is nested field name
isnest=1; % yes nest logical
nmops=size(S,2);
MopNumber=S(1).SA(1).Mopnum;
end

% assign the survey datenum to plot if one was input
if nargin == 2;SurvNum=varargin{2};else;SurvNum=[];end    

%SurvDateNum=(vertcat(eval(['S.' MopStructType '.Datenum']))); 

% figure out if input struct variable is a nested struct array

% if strcmp(MopStructType,'SA') || strcmp(MopStructType,'SG') || ...
%         strcmp(MopStructType,'SM') || strcmp(MopStructType,'SW')
%     nested=0; % not nested
%     
% else
%     nested=1; % nested
%     MopStructType=fieldnames(S); % Mop struct type is nested field name
% end


%-------------------------------------------------------------------
%   SA  survey data
%-------------------------------------------------------------------

if strcmp(MopStructType,'SA') 
    
%  make 3d color scatter plot of x,y,z, offset z in the vertical using the
%    datenum
    %figure('position',[31    82   725   674]);
    for m=1:nmops % loop through Mop areas
        %for d=1:length(SurvDateNum) % loop through dates
         if isempty(SurvNum)
            if isnest
             x=vertcat(S(m).SA(1).X);
             y=vertcat(S(m).SA(1).Y);
             z=vertcat(S(m).SA(1).Z);
            else
             x=vertcat(S(1).X);
             y=vertcat(S(1).Y);
             z=vertcat(S(1).Z);
            end
         else
            if isnest
             x=vertcat(S(m).SA(SurvNum).X);
             y=vertcat(S(m).SA(SurvNum).Y);
             z=vertcat(S(m).SA(SurvNum).Z);
            else
             tidx=find(vertcat(S.Datenum) == SurvNum);
             x=vertcat(S(SurvNum).X);
             y=vertcat(S(SurvNum).Y);
             z=vertcat(S(SurvNum).Z);
            end
         end
           
            % screen for NaN elevations
            x(isnan(z))=[];y(isnan(z))=[];z(isnan(z))=[];
            % screen for extreme min-max elevations
            x(z < -15)=[];y(z < -15)=[];z(z < -15)=[];
            x(z > 10)=[];y(z > 10)=[];z(z > 10)=[];
            PlotMethod='3d';
            %PlotMopTransectUTM(MopNumber-2,PlotMethod,'k','ShadeOff');
            PlotMopTransectUTM(MopNumber-1,PlotMethod,'k','ShadeOff');
            PlotMopTransectUTM(MopNumber,PlotMethod,'m','ShadeOn');
            PlotMopTransectUTM(MopNumber+1,PlotMethod,'k','ShadeOff');
            %PlotMopTransectUTM(MopNumber+2,PlotMethod,'k','ShadeOff');
     
            ScatterPlotBeachUTM(x,y,z,'3Dcolor');
            set(gca,'color',[.6 .6 .6]);
             hold on;
             view(3)
 %         end
    end

 %set(gca,'zlim',[datenum(1997,1,1) datenum(now)]);
 %datetick('z','keepticks')
 %datetick('z','yyyy/mm','keepticks')
 grid on;
 BeachColorbar 
end

if strcmp(MopStructType,'SG') 
    
    
%             % screen for NaN elevations
%             x(isnan(z))=[];y(isnan(z))=[];z(isnan(z))=[];
%             % screen for extreme min-max elevations
%             x(z < -15)=[];y(z < -15)=[];z(z < -15)=[];
%             x(z > 10)=[];y(z > 10)=[];z(z > 10)=[];
            PlotMethod='3d';
            %PlotMopTransectUTM(MopNumber-2,PlotMethod,'k','ShadeOff');
            PlotMopTransectUTM(MopNumber-1,PlotMethod,'k','ShadeOff');
            PlotMopTransectUTM(MopNumber,PlotMethod,'m','ShadeOn');
            PlotMopTransectUTM(MopNumber+1,PlotMethod,'k','ShadeOff');
            %PlotMopTransectUTM(MopNumber+2,PlotMethod,'k','ShadeOff');
     
            
x=S(NumSurv).X2D;
y=S(NumSurv).Y2D;


[X,Y]=meshgrid(min(x):max(x),min(y):max(y));
idx=sub2ind(size(X),y-min(y)+1,x-min(x)+1);
Z=X*NaN;

% plot surfaces 
Z(idx)=S.Z2Dmin;
p1=surf(X,Y,Z,'linestyle','none','facecolor',[.5 .5 .5],'facealpha',.9);
hold on;
Z(idx)=S.Z2Dmean;
p2=surf(X,Y,Z,'linestyle','none','facecolor','b','facealpha',.5);
Z(idx)=S.Z2Dmedian;
p3=surf(X,Y,Z,'linestyle','none','facecolor','g','facealpha',.5);
Z(idx)=S.Z2Dmax;
p4=surf(X,Y,Z,'linestyle','none','facecolor','r','facealpha',.5);
legend([p1 p2 p3 p4],'Global Min','Global Mean','Global Median',...
    'Global Max','location','northwest')
    
grid on;
set(gca,'color',[.7 .7 .7],'fontsize',14);

 BeachColorbar 
end 

if strcmp(MopStructType,'SM') 
    
%  make 3d color scatter plot of x,y,z, offset z in the vertical using the
%    datenum
    %figure('position',[31    82   725   674]);
    for m=1:nmops % loop through Mop areas
        %for d=1:length(SurvDateNum) % loop through dates
         if isempty(SurvNum)
            x=vertcat(S(m).SM(:).X1D);
            %y=vertcat(S(m).SM(:).Y);
            zt=vertcat(S(m).SM(:).Z1Dtransect);
            zmn=vertcat(S(m).SM(:).Z1Dmean);
            zmd=vertcat(S(m).SM(:).Z1Dmedian);
            zstd=vertcat(S(m).SM(:).Z1Dstd);
            zmin=vertcat(S(m).SM(:).Z1Dmin);
            zmax=vertcat(S(m).SM(:).Z1Dmax);
         else
            tidx=SurvNum;
            x=vertcat(S(tidx).X1D);
            %y=vertcat(S(tidx).Y);
            zt=vertcat(S(tidx).Z1Dtransect);
            zmn=vertcat(S(tidx).Z1Dmean);
            zmd=vertcat(S(tidx).Z1Dmedian);
            zstd=vertcat(S(tidx).Z1Dstd);
            zmin=vertcat(S(tidx).Z1Dmin);
            zmax=vertcat(S(tidx).Z1Dmax);
         end
           
%             % screen for NaN elevations
%             x(isnan(z))=[];z(isnan(z))=[];
%            
%             % screen for extreme min-max elevations
%             x(z < -15)=[];z(z < -15)=[];
%             x(z > 10)=[];z(z > 10)=[];
%             PlotMethod='3d';
%             %PlotMopTransectUTM(MopNumber-2,PlotMethod,'k','ShadeOff');
%             PlotMopTransectUTM(MopNumber-1,PlotMethod,'k','ShadeOff');
%             PlotMopTransectUTM(MopNumber,PlotMethod,'m','ShadeOn');
%             PlotMopTransectUTM(MopNumber+1,PlotMethod,'k','ShadeOff');
%             %PlotMopTransectUTM(MopNumber+2,PlotMethod,'k','ShadeOff');
     
            
%             ScatterPlotMopUTM(x,x*0,z,'3Dcolor');
            set(gca,'linewidth',2);hold on;
            p1=plot(x,zt,'k-','linewidth',2);set(gca,'xdir','reverse','fontsize',14);
            hold on;
            p2=plot(x,zmn,'g-','linewidth',2);set(gca,'xdir','reverse','fontsize',14);
            p3=plot(x,zmin,'r-','linewidth',1);set(gca,'xdir','reverse','fontsize',14);
            p4=plot(x,zmax,'r-','linewidth',1);set(gca,'xdir','reverse','fontsize',14);
            
            ztide=[-0.631 -.058 .218 .774 1.344 1.566 2.119 ];
            xl=get(gca,'xlim');
            for n=1:length(ztide)
                if n == 4
                 plot(xl,[ztide(n) ztide(n)],'b--');  
                else
                 plot(xl,[ztide(n) ztide(n)],'b:','linewidth',1);  
                end
            end

        %set(gca,'xlim',[0 3]);grid on;
        text(xl(1),ztide(1),' LAT','fontsize',14);
        text(xl(1),ztide(2),' MLLW');
        text(xl(1),ztide(3),' MLW');
        text(xl(1),ztide(4),' MSL','fontsize',14);
        text(xl(1),ztide(5),' MHW');
        text(xl(1),ztide(6),' MHHW');
        text(xl(1),ztide(7),' HAT','fontsize',14);
            
        legend([p1 p2 p3],'Transect Profile','Area Mean Profile',...
                'Area Min-Max Profile Elevations','location','northwest');
            
            
        ylabel('Elevation (m, NAVD88)');
        xlabel('Xshore Distance from MOP Back Beach Point (m)');
        hold on;
            % set(gca,'color',[.6 .6 .6]);
%              view(2)
 %         end
    end

 grid on;
%  BeachColorbar 
end 

%------------------------------- 
% Global Morphology 1D Profiles
%------------------------------- 
if strcmp(MopStructType,'GM') && SurvNum == 1 
                    
    set(gca,'linewidth',2);hold on;
    p1=plot(S.X1D,S.Z1Dtransect,'k-','linewidth',2);set(gca,'xdir','reverse','fontsize',14);
    hold on;
    p2=plot(S.X1D,S.Z1Dmean,'g-','linewidth',2);set(gca,'xdir','reverse','fontsize',14);
    p3=plot(S.X1D,S.Z1Dmedian,'g:','linewidth',2);set(gca,'xdir','reverse','fontsize',14);
    p4=plot(S.X1D,S.Z1Dmin,'r-','linewidth',1);set(gca,'xdir','reverse','fontsize',14);
    p5=plot(S.X1D,S.Z1Dmax,'r-','linewidth',1);set(gca,'xdir','reverse','fontsize',14);
            
    ztide=[-0.631 -.058 .218 .774 1.344 1.566 2.119 ];
    xl=get(gca,'xlim');
     for n=1:length(ztide)
       if n == 4
           plot(xl,[ztide(n) ztide(n)],'b--');  
       else
           plot(xl,[ztide(n) ztide(n)],'b:','linewidth',1);  
       end
     end

     text(xl(1),ztide(1),' LAT','fontsize',14);
     text(xl(1),ztide(2),' MLLW');
     text(xl(1),ztide(3),' MLW');
     text(xl(1),ztide(4),' MSL','fontsize',14);
     text(xl(1),ztide(5),' MHW');
     text(xl(1),ztide(6),' MHHW');
     text(xl(1),ztide(7),' HAT','fontsize',14);
            
     legend([p1 p2 p3 p4],'Global Mean Transect Profile','Global Area Mean Profile',...
            'Global Area Median Profile',...
                'Global Area Min-Max Profile Elevations','location','northwest');
                   
     ylabel('Elevation (m, NAVD88)');
     xlabel('Xshore Distance from MOP Back Beach Point (m)');
     hold on;

     grid on;

end 

%------------------------------- 
% Global Morphology 2D Bathy
%------------------------------- 
if strcmp(MopStructType,'GM')  && SurvNum == 2 

           
            PlotMethod='3d';
            %PlotMopTransectUTM(MopNumber-2,PlotMethod,'k','ShadeOff');
            PlotMopTransectUTM(MopNumber-1,PlotMethod,'k','ShadeOff');
            PlotMopTransectUTM(MopNumber,PlotMethod,'m','ShadeOn');
            PlotMopTransectUTM(MopNumber+1,PlotMethod,'k','ShadeOff');
            %PlotMopTransectUTM(MopNumber+2,PlotMethod,'k','ShadeOff');
               
            % convert gridded x,y,z points to 2d matrices
x=S.X2D;
y=S.Y2D;


[X,Y]=meshgrid(min(x):max(x),min(y):max(y));
idx=sub2ind(size(X),y-min(y)+1,x-min(x)+1);
Z=X*NaN;

% plot surfaces 
Z(idx)=S.Z2Dmin;
p1=surf(X,Y,Z,'linestyle','none','facecolor',[.5 .5 .5],'facealpha',.9);
hold on;
Z(idx)=S.Z2Dmean;
p2=surf(X,Y,Z,'linestyle','none','facecolor','b','facealpha',.5);
Z(idx)=S.Z2Dmedian;
p3=surf(X,Y,Z,'linestyle','none','facecolor','g','facealpha',.5);
Z(idx)=S.Z2Dmax;
p4=surf(X,Y,Z,'linestyle','none','facecolor','r','facealpha',.5);
legend([p1 p2 p3 p4],'Global Min','Global Mean','Global Median',...
    'Global Max','location','northwest')
    
grid on;
set(gca,'color',[.7 .7 .7],'fontsize',14);
 
y_labels = get(gca, 'YTick');
set(gca, 'YTickLabel', num2str(y_labels'));ytickangle(45);
ylabel('Northings (m)');
x_labels = get(gca, 'XTick');
set(gca, 'XTickLabel', num2str(x_labels'));xtickangle(45);
xlabel('Eastings (m)');
 
 %BeachColorbar 
end 

%------------------------------- 
% Global Monthly Morphology 2D Bathy
%------------------------------- 

if strcmp(MopStructType,'GM')  && SurvNum > 2
    
    mon=SurvNum-2;

           
            PlotMethod='3d';
            %PlotMopTransectUTM(MopNumber-2,PlotMethod,'k','ShadeOff');
            PlotMopTransectUTM(MopNumber-1,PlotMethod,'k','ShadeOff');
            PlotMopTransectUTM(MopNumber,PlotMethod,'m','ShadeOn');
            PlotMopTransectUTM(MopNumber+1,PlotMethod,'k','ShadeOff');
            %PlotMopTransectUTM(MopNumber+2,PlotMethod,'k','ShadeOff');
               
            % convert gridded x,y,z points to 2d matrices
x=S.X2D;
y=S.Y2D;

[X,Y]=meshgrid(min(x):max(x),min(y):max(y));
idx=sub2ind(size(X),y-min(y)+1,x-min(x)+1);
Z=X*NaN;

%plot global min surface 
Z(idx)=S.Z2Dmin;
p1=surf(X,Y,Z,'linestyle','none','facecolor',[.5 .5 .5],'facealpha',.9);

% month surface
x=S.MM(mon).X2D;
y=S.MM(mon).Y2D;

[X,Y]=meshgrid(min(x):max(x),min(y):max(y));
idx=sub2ind(size(X),y-min(y)+1,x-min(x)+1);
Z=X*NaN;

% plot surfaces 
% Z(idx)=S.Z2Dmin;
% p1=surf(X,Y,Z,'linestyle','none','facecolor',[.5 .5 .5],'facealpha',.9);
hold on;
Z(idx)=S.MM(mon).Z2Dmean;
p2=surf(X,Y,Z,'linestyle','none','facecolor','b','facealpha',.5);
Z(idx)=S.MM(mon).Z2Dmedian;
p3=surf(X,Y,Z,'linestyle','none','facecolor','g','facealpha',.5);
% Z(idx)=S.MM(mon).Z2Dmax;
% p4=surf(X,Y,Z,'linestyle','none','facecolor','r','facealpha',.5);
legend([p1 p2 p3],'Global Min','Global Month Mean','Global Month Median',...
    'location','northwest')
    
grid on;
set(gca,'color',[.7 .7 .7],'fontsize',14);
 
y_labels = get(gca, 'YTick');
set(gca, 'YTickLabel', num2str(y_labels'));ytickangle(45);
ylabel('Northings (m)');
x_labels = get(gca, 'XTick');
set(gca, 'XTickLabel', num2str(x_labels'));xtickangle(45);
xlabel('Eastings (m)');
 
 %BeachColorbar 
end 

if strcmp(MopStructType,'SW') 

    subplot(3,1,1)
    set(gca,'fontsize',14);hold on;
    p1=plot([S.Datenum],[S.Emean],'ks');
    p2=plot([S.Datenum],[S.Emedian],'bo');
    p3=plot([S.Datenum],[S.E90q],'b*');
    p4=plot([S.Datenum],[S.E95q],'c*');
    p5=plot([S.Datenum],[S.E98q],'r*');
    p6=plot([S.Datenum],[S.Emax],'k^');
    grid on;
    datetick(gca)
    ylabel('Wave Energy (m^2)');xlabel('Date');
    legend('Mean','Median','Q90','Q95','Q98','Max',...
        'location','northwest');
    
    subplot(3,1,2)
    set(gca,'fontsize',14);hold on;
    p1=plot([S.Datenum],[S.SxyMean],'ks');
    p2=plot([S.Datenum],[S.SxyMedian],'bo');
    p3=plot([S.Datenum],[S.SxyMax],'k^');
    grid on;
    datetick(gca)
    ylabel('Sxy (m^2)');xlabel('Date');
    legend('Mean','Median','Max',...
        'location','northwest');
      
    subplot(3,1,3)
    set(gca,'fontsize',14);hold on;
    p1=plot([S.Datenum],[S.SxyNet],'k-*');
    grid on;
    datetick(gca)
    ylabel('Cumulative Sxy (m^2)');xlabel('Date');
    %legend('Mean','Median','Max');

end 


fh=get(gcf);       

end


